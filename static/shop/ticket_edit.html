<!DOCTYPE html>
<html lang="en">
	<!-- container-fluid -->
	<head>
		<title>Unicorn Admin</title>
		<meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--公用样式-->
		<link rel="stylesheet" href="../public/css/bootstrap.min.css" />
		<link rel="stylesheet" href="../public/css/bootstrap-responsive.min.css" />	
		<link rel="stylesheet" href="../public/css/unicorn.main.css" />
		<link rel="stylesheet" href="../public/css/unicorn.grey.css" />
		<!--页面样式-->
		<link href="../public/kindeditor/themes/default/default.css" type="text/css" rel="stylesheet">
		<link href="../public/css/datepicker.css" type="text/css" rel="stylesheet">
		<link href="../public/css/select2.css" type="text/css" rel="stylesheet">
	</head>
	<body>
		<div id="header">
			<h1><a href="./dashboard.html">APP 商户管理系统</a></h1>		
		</div>
		
		<div id="hotline" class="muted">服务热线：400-800-8888</div>

		<div id="user-nav" class="navbar navbar-inverse">
			<dl class="user-info">
				<dt class="muted">福建省宁德米克中式餐饮</dt>
				<dd><span class="muted">用户名：</span><b class="text-error">80222222</b></dd>
				<dd><span class="muted">可提现金额：</span><b class="text-error">￥3088.00</b></dd>
			</dl>
            <ul class="nav btn-group">
                <li class="btn btn-inverse"><a title="" href="#"><i class="icon icon-share"></i> <span class="text">提现</span></a></li>
                <li class="btn btn-inverse"><a title="" href="login.html"><i class="icon icon-off"></i> <span class="text">退出登陆</span></a></li>
            </ul>
        </div>
            
		<div id="sidebar">
			<ul>
				<li><a href="index.html"><i class="icon icon-home"></i> <span>首页</span></a></li>
				<li class="submenu">
					<a href="#"><i class="icon icon-gift"></i> <span>活动管理</span> <span class="label">2</span></a>
					<ul>
						<li><a href="activity_list.html">活动列表</a></li>
						<li><a href="activity_add.html">新增活动</a></li>
					</ul>
				</li>
				<li class="submenu">
					<a href="#"><i class="icon icon-tint"></i> <span>产品管理</span><span class="label">3</span></a>
					<ul>
						<li><a href="goods_list.html">产品列表</a></li>
						<li><a href="goods_add.html">新增产品</a></li>
						<li><a href="categroy.html">分类管理</a></li>
					</ul>
				</li>
				<li><a href="order.html"><i class="icon icon-shopping-cart"></i> <span>订单管理</span></a></li>
				<li class="submenu">
					<a href="#"><i class="icon icon-picture"></i> <span>图片墙管理</span> <span class="label">2</span></a>
					<ul>
						<li><a href="image_list.html">图片墙列表</a></li>
						<li><a href="image_add.html">新增图片墙</a></li>
					</ul>
				</li>
				<li><a href="user.html"><i class="icon icon-user"></i> <span>会员管理</span></a></li>
				<li><a href="comment.html"><i class="icon icon-comment"></i> <span>留言管理</span></a></li>
				<li class="submenu active open">
					<a href="#"><i class="icon icon-tags"></i> <span>电子券管理</span> <span class="label">2</span></a>
					<ul>
						<li class="active"><a href="ticket_list.html">电子券列表</a></li>
						<li><a href="ticket_add.html">新增电子券</a></li>
					</ul>
				</li>
				<li>
					<a href="ad.html"><i class="icon icon-bullhorn"></i> <span>广告设置</span></a>
				</li>
				<li class="submenu">
					<a href="#"><i class="icon icon-hdd"></i> <span>数据库统计</span> <span class="label">4</span></a>
					<ul>
						<li><a href="pv.html">访问量统计</a></li>
						<li><a href="sale.html">销量统计</a></li>
						<li><a href="charge.html">充值量统计</a></li>
						<li><a href="backup.html">数据备份导出</a></li>
					</ul>
				</li>
				<li class="submenu">
					<a href="#"><i class="icon icon-cog"></i> <span>系统设置</span> <span class="label">6</span></a>
					<ul>
						<li><a href="change_pw.html">登录设置</a></li>
						<li><a href="profile.html">资料设置</a></li>
						<li><a href="message.html">推送服务</a></li>
						<li><a href="rule.html">规则设置</a></li>
						<li><a href="resource.html">素材库管理</a></li>
						<li><a href="cash.html">提现管理</a></li>
					</ul>
				</li>
			</ul>
		</div>
		
		<div id="content">

			<div class="widget-box" >
				<div class="widget-title">
					<span class="icon">
						<i class="icon-tags"></i>
					</span>
					<h5>新增电子券</h5>
				</div>
				<div class="widget-content">
					<form action="#" method="get" class="form-horizontal" id="j-ticket-addForm" />
						<div class="control-group">
							<label class="control-label">名称</label>
							<div class="controls">
								<input type="text" id="j-ticket-title" />
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">有效期</label>
							<div class="controls">
								<input type="text" data-date="12-02-2012" data-date-format="dd-mm-yyyy" value="12-02-2012" class="input-medium j-datepicker" id="j-ticket-expire_date" />
								<label class="checkbox inline"><input type="checkbox" id="j-ticket-date_forever"> 长期有效</label>
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">活动图片</label>
							<div class="controls">
								
								<a class="btn btn-info" href="javascript:;" id="j-btn-imageUpload"><i class="icon-folder-open icon-white"></i> 本地上传</a>
								<a class="btn btn-success" href="javascript:;" id="j-btn-imageManager"><i class="icon-picture icon-white"></i> 素材库选择</a>
								<span class="help-inline">上传过的图片可以直接从素材库选择</span>
								<div class="clearfix" style="margin-top:10px;">
									<span class="thumbnail pull-left">
										<img src="http://placehold.it/128x128" alt="" id="j-img-placehold">
									</span>
								</div>
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">兑换所需积分</label>
							<div class="controls">
								<input type="text" id="j-ticket-score" class="input-medium" />
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">兑换所需积分</label>
							<div class="controls">
								满 <input type="text" id="j-ticket-total" class="input-small" /> 元，减 <input type="text" id="j-ticket-discount" class="input-small" /> 元
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">限定使用商品</label>
							<div class="controls">
								<div class="select2-container select2-container-multi select2-dropdown-open" id="j-goods-select">
									<ul class="select2-choices" id="j-goods-selected">
									</ul>
									<div class="fixed-modal" id="j-goods-selectModal" style="display:none;">
										<div class="modal-header">
											<a data-dismiss="modal" class="close" href="javascript:;">×</a>
											<h3>选择限定使用的商品</h3>
										</div>
										<div class="modal-body">
											<ul class="activity-list" id="j-goods-list">

							                </ul>
										</div>
										<div class="modal-footer">
											<div class="pagination alternate" id="j-goods-pagination">
												<ul class="page-main">
												</ul>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="control-group">
							<label class="control-label">使用说明</label>
							<div class="controls">
								<textarea name="content" style="height:400px;visibility:hidden;"></textarea>
							</div>
						</div>
						<div class="form-actions">
							<button type="reset" class="btn"><i class="icon-refresh"></i> 清除重置</button>
							<button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> 完成保存</button>
						</div>
					</form>
				</div>
			</div>

			<div id="footer">
				<p>关于淘宝合作伙伴营销中心廉正举报联系客服开放平台诚征英才联系我们网站地图法律声明© 2003-2014 Taobao.com 版权所有</p>
				<p>网络文化经营许可证：文网文[2010]040号|增值电信业务经营许可证：浙B2-20080224-1|信息网络传播视听节目许可证：1109364号 </p>
			</div>
		</div>
		
		<!--公用js-->
        <script src="../public/js/jquery.min.js"></script>
        <script src="../public/js/jquery.ui.custom.js"></script>
        <script src="../public/js/bootstrap.min.js"></script>
        <script src="../public/js/unicorn.js"></script>
        <script src="../public/js/jquery.tmpl.min.js"></script>
        <script src="../public/js/common.js"></script>

        <!--页面js-->
        <script src="../public/js/ue.pager.js"></script>
        <script src="../public/js/bootstrap-datepicker.js"></script>

        <script charset="utf-8" src="../public/kindeditor/kindeditor-min.js"></script>
		<script charset="utf-8" src="../public/kindeditor/lang/zh_CN.js"></script>

		<script type="text/jquery-tmpl-x" id="j-tmpl-goods-selecteditem">
			{{each(i, v) goods_selected}}
				<li class="select2-search-choice" data-id="${v.id}">
					<div class="j-title">${v.title}</div>
					<a href="javascript:;" class="select2-search-choice-close j-btn-del"></a>
				</li>
			{{/each}}
		</script>

		
		<script type="text/jquery-tmpl-x" id="j-tmpl-goods-listitem">
        	{{each(i, v) list}}
	        	<li data-id="${v.id}"><a href="#" class="j-title">${v.title}</a></li>
			{{/each}}
        </script>

        <script type="text/javascript">
        	var MPage = {
        		init : function(){
        			var mpage = this;

        			var text_editor,
        				image_editor;
					KindEditor.ready(function(K) {
						//文本编辑器
						mpage.text_editor = text_editor = K.create('textarea[name="content"]', {
							uploadJson : '../public/kindeditor/php/upload_json.php',
							allowFileManager : true
						});

						//图片上传编辑
						mpage.image_editor = image_editor = K.editor({
							uploadJson : '../public/kindeditor/php/upload_json.php',
							fileManagerJson : '../public/kindeditor/php/file_manager_json.php'
						});
						
						//图片上传绑定
						K('#j-btn-imageManager').click(function() {
							image_editor.loadPlugin('filemanager', function() {
								image_editor.plugin.filemanagerDialog({
									viewType : 'VIEW',
									dirName : 'image',
									clickFn : function(url, title) {
										K('#j-img-placehold').attr("src", url);
										image_editor.hideDialog();
									}
								});
							});
						});

						//从资料库选择图片
						K('#j-btn-imageUpload').click(function() {
							image_editor.loadPlugin('image', function() {
								image_editor.plugin.imageDialog({
									showRemote : false,
									imageUrl : K('#j-img-placehold').attr("src"),
									clickFn : function(url, title, width, height, border, align) {
										K('#j-img-placehold').attr("src", url);
										image_editor.hideDialog();
									}
								});
							});
						});

						//解析url中的id
						/\?id=(\d+)/.test(document.location.href);
						var ticket_id = RegExp.$1;
						if(ticket_id){
							mpage.getTicketDetail(ticket_id);
						} else {
							alert("该电子券不存在");
							window.history.back();
						}
					});
					
					$('.j-datepicker').datepicker();

					$("#j-ticket-date_forever").bind("change", function(){
						if($(this).attr("checked")){
							$("#j-ticket-expire_date").attr("disabled", "disabled");
						}else{
							$("#j-ticket-expire_date").removeAttr("disabled");
						}
					});

					//绑定选择商品
					$("#j-goods-select").bind("click", function(){
						mpage.getGoodsList(1);
						$('#j-goods-selectModal').show();
					});

					$('#j-goods-selectModal .close').bind("click", function(){
						$('#j-goods-selectModal').hide()
						return false;
					});

					$("#j-goods-selected").delegate(".j-btn-del", "click", function(){
						$(this).parents("li").remove();
						return false;
					});

					//绑定提交表单
					$("#j-ticket-addForm").bind("submit", function(){
						

						//限定的商品
						var goods_selected = [];

						$("#j-goods-selected li").each(function(){
							var $item = $(this),
								id = $item.attr("data-id");

							goods_selected.push(id);
						});

						var save_data = {
							title : $.trim($("#j-ticket-title").val()),
							expire_date : $("#j-ticket-date_forever").attr("checked") ? -1 : $("#j-ticket-expire_date").val(),
							thumbnail : $('#j-img-placehold').attr("src"),
							score : $("#j-ticket-score").val(),
							total : $("#j-ticket-total").val(),
							discount : $("#j-ticket-discount").val(),
							goods_selected : goods_selected,
							content : text_editor.html()
						}

						console.log(save_data);
						alert('提交数据')
						return false;
					});

					//绑定重置表单
					$("#j-ticket-addForm").bind("reset", function(){
						mpage.setFormData();
						return false;
					});
        		},

        		getTicketDetail : function(ticket_id){
        			var mpage = this;

        			//$.getJSON("", { id: ticket_id}， function(json){
        				var json = {
        					code : 0,
							msg : "", 
							result : {
								title : '电子券名称',
								expire_date : -1,
								thumbnail : 'http://placehold.it/128x128',
								score : 50,
								total : 100,
								discount : 20,
								goods_selected : [
									{
										id : 1,
										title : "商品"
									},
									{
										id : 2,
										title : "商品"
									},
									{
										id : 3,
										title : "商品"
									}
								],
								content : 'asfasfsadfas'
							}
        				}

        				mpage.detailData = json.result;
        				mpage.setFormData();
        			//});
        		},

        		setFormData : function(){
        			var mpage = this,
        				detail = mpage.detailData;

        			$("#j-ticket-title").val(detail.title);

        			if(detail.expire_date == -1){
        				$("#j-ticket-date_forever").attr("checked", "checked");
        				$("#j-ticket-expire_date").attr("disabled", "disabled");
        			} else {
        				$("#j-ticket-expire_date").removeAttr("checked");
        				$("#j-ticket-date_forever").removeAttr("disabled", "disabled").val(detail.expire_date);
        			}
    				
    				$('#j-img-placehold').attr("src", 'http://placehold.it/128x128');
    				$("#j-ticket-score").val(detail.score);
					$("#j-ticket-total").val(detail.total);
					$("#j-ticket-discount").val(detail.discount);
					$("#j-goods-selected").html( $("#j-tmpl-goods-selecteditem").tmpl({
						goods_selected : detail.goods_selected	
					}) );
    				mpage.text_editor.html(detail.content);
        		},

        		getGoodsList : function (p){
    		    	var mpage = this;

					//$.getJSON("", { p: p}， function(json){
						var json = {
							code : 0,
							msg : "", 
							result : {
								count : 59,
								list : [
									{
										id : 1,
										title : "商品"
									},
									{
										id : 2,
										title : "商品"
									},
									{
										id : 3,
										title : "商品"
									},
									{
										id : 4,
										title : "商品"
									},
									{
										id : 5,
										title : "商品"
									},
									{
										id : 6,
										title : "商品"
									}
								]
							}
						};
						
						$("#j-goods-list").html( $("#j-tmpl-goods-listitem").tmpl(json.result) );

						$("#j-goods-list li").unbind("click").bind("click", function(){
							var id = $(this).attr("data-id"),
								title = $(this).find(".j-title").text();

							$("#j-goods-selected").append( $("#j-tmpl-goods-selecteditem").tmpl({
								goods_selected : [
									{
										id : id,
										title : title
									}
								]	
							}) );
							return false;
						});

						ue.pager({
							//target : $(".list_pager"),//放置分页的元素
							pagerTarget : $("#j-goods-pagination ul"),
							first : '<li><a href="#">首页</a></li>',
							firstDisabled : '<li class="disabled"><a href="#">首页</a></li>',
							last : '<li><a href="#">末页</a></li>',
							lastDisabled : '<li class="disabled"><a href="#">末页</a></li>',
							prev : '<li><a href="#">上一页</a></li>',
							prevDisabled : '<li class="disabled"><a href="#">上一页</a></li>',
							next : '<li><a href="#">下一页</a></li>',
							nextDisabled : '<li class="disabled"><a href="#">下一页</a></li>',
							current : '<li class="active"><a href="#">@{page}</a></li>',
							page : '<li><a href="#">@{page}</a></li>',
							tip : '<li class="page-info"><b class="text-info">@{nowPage}</b>/@{pageCount}页 共<b class="text-info">@{count}</b>条记录</li>',
							now : p,//当前页
							maxPage : 5,//显示的最多页数
							per : 6,//每页显示几个
							count : json.result.count,
							onchange : function(page){//切换页数回调函数
								mpage.getGoodsList(page);
							}
						})
					//});
	
				}
    		}

    		$(function(){
    			MPage.init();
    		});
    		
        </script>
	</body>
</html>
